
<h3 id="leveling-up-with-htmltemplate">Leveling up with html/template</h3>

<p>Now let’s get back to what we’re trying to achieve with our project. Our home page will be responsible for rendering multiple products and its images, so what I’ve done is create a package named <code class="language-plaintext highlighter-rouge">models</code> with structs for <code class="language-plaintext highlighter-rouge">Product</code>, <code class="language-plaintext highlighter-rouge">Image</code> and <code class="language-plaintext highlighter-rouge">IndexViewModel</code>.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">models</span>

<span class="c">// Image is an array of bytes of any image</span>
<span class="k">type</span> <span class="n">Image</span> <span class="p">[]</span><span class="kt">byte</span>

<span class="c">// Product model of something we have to sell</span>
<span class="k">type</span> <span class="n">Product</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Title</span>       <span class="kt">string</span>
	<span class="n">Price</span>       <span class="kt">float32</span>
	<span class="n">Description</span> <span class="kt">string</span>
	<span class="n">Images</span>      <span class="p">[]</span><span class="n">Image</span>
<span class="p">}</span>

<span class="c">// IndexViewModel is used by our index page</span>
<span class="k">type</span> <span class="n">IndexViewModel</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Title</span>    <span class="kt">string</span>
	<span class="n">Products</span> <span class="p">[]</span><span class="n">Product</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Index handler has been moved to its own package named <code class="language-plaintext highlighter-rouge">handlers</code> and also changed to return some fake products for now.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">handlers</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"net/http"</span>

	<span class="s">"github.com/goenning/gostore/models"</span>
<span class="p">)</span>

<span class="c">//Index is our main page handler</span>
<span class="k">func</span> <span class="n">Index</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">products</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">models</span><span class="o">.</span><span class="n">Product</span><span class="p">{</span>
		<span class="p">{</span>
			<span class="n">Title</span><span class="o">:</span> <span class="s">"iMac 27</span><span class="se">\"</span><span class="s"> 5K"</span><span class="p">,</span>
			<span class="n">Price</span><span class="o">:</span> <span class="m">1600</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="n">Title</span><span class="o">:</span> <span class="s">"Giant Bike in mint conditions"</span><span class="p">,</span>
			<span class="n">Price</span><span class="o">:</span> <span class="m">1299.99</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">models</span><span class="o">.</span><span class="n">IndexViewModel</span><span class="p">{</span>
		<span class="n">Title</span><span class="o">:</span>    <span class="s">"Go Store :)"</span><span class="p">,</span>
		<span class="n">Products</span><span class="o">:</span> <span class="n">products</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="n">w</span><span class="o">.</span><span class="n">WriteHeader</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">)</span>
	<span class="n">render</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">"index.html"</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The only code that changed on <code class="language-plaintext highlighter-rouge">main.go</code> is <code class="language-plaintext highlighter-rouge">r.HandleFunc("/", index)</code>, which now has to reference the package where the handler can be found <code class="language-plaintext highlighter-rouge">r.HandleFunc("/", handlers.Index)</code>.</p>

<p>Our view has also changed to loop over all products and print its Title and Price.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width,initial-scale=1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>{{.Title}}<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
      Welcome to your own <span class="nt">&lt;strong&gt;</span>{{.Title}}<span class="nt">&lt;/strong&gt;</span>

    <span class="nt">&lt;ul&gt;</span>
        {{range .Products}}
            <span class="nt">&lt;li&gt;</span>{{.Title}}: {{.Price | currency}}<span class="nt">&lt;/li&gt;</span>
        {{end}}
    <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>If you look at this template carefully you’ll notice the use of <code class="language-plaintext highlighter-rouge">| currency</code>. This is an user defined function that can be used on views to enchance/modify the visualization of some date. In this case, <code class="language-plaintext highlighter-rouge">Currency</code> is formatting our price to a human friendly string.</p>

<p>This is done by using a custom <code class="language-plaintext highlighter-rouge">render</code> function that is described below.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">handlers</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"html/template"</span>
	<span class="s">"net/http"</span>

	<span class="s">"github.com/leekchan/accounting"</span>
<span class="p">)</span>

<span class="k">var</span> <span class="n">tpl</span> <span class="o">*</span><span class="n">template</span><span class="o">.</span><span class="n">Template</span>
<span class="k">var</span> <span class="n">err</span> <span class="kt">error</span>

<span class="c">// CurrencyExpander formats currency based on current Accounting settings</span>
<span class="k">func</span> <span class="n">CurrencyExpander</span><span class="p">(</span><span class="n">args</span> <span class="o">...</span><span class="k">interface</span><span class="p">{})</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="n">ac</span> <span class="o">:=</span> <span class="n">accounting</span><span class="o">.</span><span class="n">Accounting</span><span class="p">{</span><span class="n">Symbol</span><span class="o">:</span> <span class="s">"$"</span><span class="p">,</span> <span class="n">Precision</span><span class="o">:</span> <span class="m">2</span><span class="p">}</span>
	<span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="kt">float32</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">ac</span><span class="o">.</span><span class="n">FormatMoney</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">loadTemplates</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">tpl</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="n">Funcs</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">FuncMap</span><span class="p">{</span>
		<span class="s">"currency"</span><span class="o">:</span> <span class="n">CurrencyExpander</span><span class="p">,</span>
	<span class="p">})</span><span class="o">.</span><span class="n">ParseGlob</span><span class="p">(</span><span class="s">"views/*.html"</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">render</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">name</span> <span class="kt">string</span><span class="p">,</span> <span class="n">data</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">tpl</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">loadTemplates</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="n">tpl</span><span class="o">.</span><span class="n">ExecuteTemplate</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When we load the templates, it’s possible to register some functions and give it a name to be used in the templates. In this example we’re also using a third-party package named <code class="language-plaintext highlighter-rouge">github.com/leekchan/accounting</code>, so don’t forget to <code class="language-plaintext highlighter-rouge">glide get github.com/leekchan/accounting</code> it.</p>
